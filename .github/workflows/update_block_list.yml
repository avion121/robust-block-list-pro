name: Update Robust Block List Pro

on:
  schedule:
    - cron: "0 0 * * *"   # Runs every midnight UTC
  workflow_dispatch:       # ✅ Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write       # Allow pushes with GITHUB_TOKEN

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4   # Updated to latest version for reliability

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"    # Stable Python version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate Block List
        run: python generate_list.py

      - name: Check for persistent fetch errors
        run: |
          if [ -s fetch_errors.log ]; then
            echo "⚠️ Fetch errors detected, check fetch_errors.log"
            cat fetch_errors.log
          fi

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add robust_block_list_pro_abp.txt robust_block_list_pro_hosts.txt fetch_errors.log fetch_meta.json || true
          if ! git diff --cached --quiet; then
            git commit -m "Update Robust Block List Pro (combined) - $(date -u +%Y-%m-%d)"
            git pull --rebase origin main || true
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:main
          else
            echo "ℹ️ No changes to commit"
          fi

      - name: Notify on persistent errors
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const errors = fs.existsSync('fetch_errors.log') ? fs.readFileSync('fetch_errors.log', 'utf8') : '';
            if (errors) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Robust Block List Pro: Fetch Errors Detected',
                body: `Persistent fetch errors occurred during the update process. Please review the logs:\n\n\`\`\`\n${errors}\n\`\`\``
              });
            }
